"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.expressMiddleware = void 0;
const chalk_1 = __importDefault(require("chalk"));
const typescript_helpers_1 = require("@olian/typescript-helpers");
const config_1 = require("../lib/config");
const expressMiddleware = (hostObj, config = {}) => {
    if (hostObj === undefined || hostObj.line === undefined) {
        throw new Error('BetterLogging.expressMiddleware requires an object decorated by betterLogging as its first argument.');
    }
    ;
    return (req, res, next) => {
        const method = {
            order: typescript_helpers_1.useValueOrFallback(config.method, 'order', 1),
            show: typescript_helpers_1.useValueOrFallback(config.method, 'show', true),
            color: typescript_helpers_1.useValueOrFallback(config.method, 'color', config_1.DefaultConfig.color.base),
            value: typescript_helpers_1.useValueOrFallback(req, 'method', ''),
        };
        const ip = {
            order: typescript_helpers_1.useValueOrFallback(config.ip, 'order', 2),
            show: typescript_helpers_1.useValueOrFallback(config.ip, 'show', true),
            color: typescript_helpers_1.useValueOrFallback(config.ip, 'color', config_1.DefaultConfig.color.base),
            value: typescript_helpers_1.useValueOrFallback(req, 'ip', ''),
        };
        const path = {
            order: typescript_helpers_1.useValueOrFallback(config.path, 'order', 3),
            show: typescript_helpers_1.useValueOrFallback(config.path, 'show', true),
            color: typescript_helpers_1.useValueOrFallback(config.path, 'color', chalk_1.default.reset),
            value: typescript_helpers_1.useValueOrFallback(req, 'path', ''),
        };
        const body = {
            order: typescript_helpers_1.useValueOrFallback(config.body, 'order', 4),
            show: typescript_helpers_1.useValueOrFallback(config.body, 'show', false),
            color: typescript_helpers_1.useValueOrFallback(config.body, 'color', chalk_1.default.reset),
            value: typescript_helpers_1.useValueOrFallback(req, 'body', ''),
        };
        const header = {
            order: typescript_helpers_1.useValueOrFallback(config.header, 'order', 5),
            show: typescript_helpers_1.useValueOrFallback(config.header, 'show', false),
            color: typescript_helpers_1.useValueOrFallback(config.header, 'color', chalk_1.default.reset),
            value: typescript_helpers_1.useValueOrFallback(req, 'headers', {}),
        };
        hostObj.info([method, ip, path, body, header]
            .sort((a, b) => a.order - b.order)
            .map(obj => !obj.show ? '' : obj.color(`${typeof obj.value === 'object'
            ? JSON.stringify(obj.value)
            : obj.value}`))
            .filter(v => v.length > 0)
            .join(' '));
        next();
    };
};
exports.expressMiddleware = expressMiddleware;
